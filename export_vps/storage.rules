rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ====================================
    // HELPER FUNCTIONS
    // ====================================
    
    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Extract tenantId from storage path
     * Expected format: tenants/{tenantId}/projects/{projectId}/photos/{photoId}.jpg
     */
    function getTenantIdFromPath() {
      return request.resource.name.split('/')[1];
    }
    
    /**
     * Check if authenticated user belongs to the tenant in the path
     */
    function isTenantUser() {
      return isAuthenticated() 
             && request.auth.token.tenantId == getTenantIdFromPath();
    }
    
    /**
     * Check if the file is an allowed image type
     */
    function isValidImage() {
      return request.resource.contentType.matches('image/jpeg')
          || request.resource.contentType.matches('image/png')
          || request.resource.contentType.matches('image/webp');
    }
    
    /**
     * Check if file size is within limits (10MB max)
     */
    function isValidSize() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // ====================================
    // DEFAULT DENY
    // ====================================
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
    
    // ====================================
    // TENANT-SCOPED PHOTO STORAGE
    // ====================================
    
    // Photos: tenants/{tenantId}/projects/{projectId}/photos/{photoId}.jpg
    match /tenants/{tenantId}/projects/{projectId}/photos/{photoId} {
      
      // Users can read photos if they belong to the tenant
      // (Project-level access control is handled by Firestore rules)
      allow read: if isAuthenticated()
                     && request.auth.token.tenantId == tenantId;
      
      // Users can upload photos if:
      // - They are authenticated
      // - They belong to the tenant
      // - The file is a valid image
      // - The file size is acceptable
      allow create: if isAuthenticated()
                       && request.auth.token.tenantId == tenantId
                       && isValidImage()
                       && isValidSize();
      
      // Photos cannot be updated or deleted
      // (They are immutable once uploaded)
      allow update, delete: if false;
    }
    
    // ====================================
    // CONCERNS-SCOPED DOCUMENT STORAGE
    // ====================================
    
    // Documents: concerns/{concernID}/projects/{projectId}/documents/{fileName}
    // Note: Since concernID is not available in auth token as custom claim,
    // we allow authenticated users to upload. The actual authorization
    // (checking if user belongs to concern) is handled in Firestore rules
    // and application logic.
    match /concerns/{concernID}/projects/{projectId}/documents/{fileName} {
      // Allow authenticated users to read documents
      // The concernID check happens in Firestore when accessing document metadata
      allow read: if isAuthenticated();
      
      // Allow authenticated users to upload documents
      // File size limit: 100MB
      // The concernID validation happens in the application code before upload
      allow create: if isAuthenticated()
                       && request.resource.size < 100 * 1024 * 1024; // 100MB
      
      // Users can update/delete if they uploaded the file or are admins
      // Note: uploadedBy is stored in customMetadata during upload
      allow update, delete: if isAuthenticated()
                              && (request.auth.uid == resource.metadata.uploadedBy
                                  || (request.auth.token.role != null 
                                      && request.auth.token.role == 'admin'));
    }
    
    // Thumbnails: concerns/{concernID}/projects/{projectId}/documents/{documentId}/thumbnails/{thumbnailName}
    match /concerns/{concernID}/projects/{projectId}/documents/{documentId}/thumbnails/{thumbnailName} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                       && request.resource.size < 5 * 1024 * 1024; // 5MB max for thumbnails
      allow update, delete: if isAuthenticated();
    }
    
    // Document versions: concerns/{concernID}/projects/{projectId}/documents/{documentId}/versions/{versionName}
    match /concerns/{concernID}/projects/{projectId}/documents/{documentId}/versions/{versionName} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                       && request.resource.size < 100 * 1024 * 1024; // 100MB max
      allow update, delete: if isAuthenticated();
    }
    
    // ====================================
    // FUTURE: OTHER TENANT-SCOPED FILES
    // ====================================
    
    // Example for documents/attachments (not used in Field App yet)
    match /tenants/{tenantId}/documents/{documentId} {
      allow read: if isAuthenticated()
                     && request.auth.token.tenantId == tenantId;
      
      allow create: if isAuthenticated()
                       && request.auth.token.tenantId == tenantId
                       && request.resource.size < 20 * 1024 * 1024; // 20MB
      
      allow update, delete: if false;
    }
  }
}
