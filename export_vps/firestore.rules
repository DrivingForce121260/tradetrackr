rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====================================
    // HELPER FUNCTIONS
    // ====================================
    
    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Check if authenticated user belongs to the specified tenant
     */
    function isTenantUser(tenantId) {
      return isAuthenticated() 
             && request.auth.token.tenantId == tenantId;
    }
    
    /**
     * Check if the authenticated user is the specified user
     */
    function isSameUser(userId) {
      return isAuthenticated() 
             && request.auth.uid == userId;
    }
    
    /**
     * Check if user has one of the specified roles
     * Supports both single role claim and roles array
     */
    function hasRole(tenantId, roles) {
      return isTenantUser(tenantId) 
             && (
               (request.auth.token.role in roles)
               || (request.auth.token.get('roles', []).hasAny(roles))
             );
    }
    
    /**
     * Check if user is a field technician
     */
    function isFieldUser(tenantId) {
      return hasRole(tenantId, ['field_tech', 'foreman']);
    }
    
    /**
     * Check if user is admin or manager
     */
    function isAdminOrManager(tenantId) {
      return hasRole(tenantId, ['admin', 'manager']);
    }
    
    /**
     * Check if user is assigned to a project
     */
    function isAssignedToProject(projectData) {
      return isAuthenticated()
             && request.auth.uid in projectData.assignedUserIds;
    }
    
    /**
     * Check if user is assigned to a task
     */
    function isAssignedToTask(taskData) {
      return isAuthenticated()
             && request.auth.uid in taskData.assignedUserIds;
    }
    
    // ====================================
    // ROOT-LEVEL RULES
    // ====================================
    
    // Legacy/flat structure support (for existing data)
    // Users collection at root level
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow authenticated users to read other users (needed for app functionality)
      allow read: if isAuthenticated();
      
      // Users can update their own document
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow creation for new signups
      allow create: if isAuthenticated();
    }
    
    // Concerns/Tenants at root level
    match /concerns/{concernId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Projects at root level
    match /projects/{projectId} {
      allow read, write: if isAuthenticated();
    }
    
    // Tasks at root level
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }
    
    // ====================================
    // CATEGORIES COLLECTION
    // ====================================
    // Normalized category system with hierarchical structure
    // Uses orgId field which maps to concernID (multi-tenant key)
    match /categories/{categoryId} {
      // Helper to get user's orgId (supports both tenantId token and concernID from user doc)
      function getUserOrgId() {
        // Try token first (for new auth system)
        return request.auth.token.tenantId != null 
          ? request.auth.token.tenantId 
          : request.auth.token.concernID;
      }
      
      // All authenticated users can read categories for their org
      allow read: if isAuthenticated()
                    && resource.data.orgId == getUserOrgId();
      
      // Only admins/managers can create/update/delete categories
      allow create: if isAuthenticated()
                      && request.resource.data.orgId == getUserOrgId()
                      && hasRole(request.resource.data.orgId, ['admin', 'manager']);
      
      allow update: if isAuthenticated()
                      && resource.data.orgId == getUserOrgId()
                      && hasRole(resource.data.orgId, ['admin', 'manager']);
      
      allow delete: if isAuthenticated()
                      && resource.data.orgId == getUserOrgId()
                      && hasRole(resource.data.orgId, ['admin', 'manager']);
    }
    
    // Materials at root level
    match /materials/{materialId} {
      allow read, write: if isAuthenticated();
    }
    
    // Customers at root level
    match /customers/{customerId} {
      allow read, write: if isAuthenticated();
    }
    
    // Reports at root level
    match /reports/{reportId} {
      allow read, write: if isAuthenticated();
    }
    
    // Documents at root level
    match /documents/{documentId} {
      allow read, write: if isAuthenticated();
    }
    
    // Email summaries at root level
    match /emailSummaries/{summaryId} {
      allow read, write: if isAuthenticated();
    }
    
    // Chats at root level
    match /chats/{chatId} {
      allow read, write: if isAuthenticated();
    }
    
    // Messages at root level
    match /messages/{messageId} {
      allow read, write: if isAuthenticated();
    }
    
    // Chat participants at root level
    match /chat_participants/{participantId} {
      allow read, write: if isAuthenticated();
    }
    
    // ====================================
    // CATEGORY STATISTICS COLLECTION
    // ====================================
    // Only admins/managers can read categoryStats for their org
    match /categoryStats/{statsId} {
      // Helper to get user's orgId (supports both tenantId token and concernID from user doc)
      function getUserOrgId() {
        // Try token first (for new auth system)
        return request.auth.token.tenantId != null 
          ? request.auth.token.tenantId 
          : request.auth.token.concernID;
      }
      
      // Check if user has admin or manager role
      function isAdminOrManager() {
        return isAuthenticated() && (
          request.auth.token.role == 'admin' ||
          request.auth.token.role == 'manager' ||
          (request.auth.token.roles != null && 
           ('admin' in request.auth.token.roles || 'manager' in request.auth.token.roles))
        );
      }
      
      allow read: if isAuthenticated() && 
        isAdminOrManager() &&
        resource.data.orgId == getUserOrgId();
      allow write: if false; // Only Cloud Functions can write
    }
    
    // ====================================
    // FEATURE REQUESTS COLLECTION
    // ====================================
    
    match /featureRequests/{requestId} {
      // Users can create feature requests for their own concernId
      allow create: if isAuthenticated()
                       && request.resource.data.concernId != null
                       && request.resource.data.userId == request.auth.uid
                       && request.resource.data.status == 'new';
      
      // Users can read their own feature requests
      allow read: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
      
      // Users can read feature requests from their concernId (for admins/managers)
      // Note: This allows reading all requests in the same concernId
      // For stricter access, check user role or restrict to own requests only
      allow read: if isAuthenticated()
                    && resource.data.concernId != null;
      
      // Users can update their own feature requests (e.g., to add comments)
      // Only allow updates to certain fields to prevent abuse
      allow update: if isAuthenticated()
                      && resource.data.userId == request.auth.uid
                      && request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['description', 'title', 'updatedAt', 'updatedBy']);
      
      // Only backend/admins can change status or other internal fields
      // For now, users cannot update status themselves
      allow update: if false; // Disable status updates from client
      
      // No deletion allowed (for audit trail)
      allow delete: if false;
    }
    
    // Allow all other collections for authenticated users (temporary)
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
    
    // ====================================
    // TENANT DOCUMENTS
    // ====================================
    
    // Tenants collection - read-only for authenticated users (for tenant resolution)
    // IMPORTANT: This allows both document reads AND collection queries (needed for login)
    match /tenants/{tenantId} {
      // Allow reading individual tenant documents
      allow get: if isAuthenticated();
      
      // Allow listing/querying tenants collection (needed for companyCode lookup during login)
      // This is safe because tenant documents only contain non-sensitive metadata
      allow list: if isAuthenticated();
      
      // Only backend can create/modify tenants
      allow write: if false;
    }
    
    // ====================================
    // TENANT-SCOPED DATA
    // ====================================
    
    match /tenants/{tenantId} {
      
      // ====================================
      // USERS SUB-COLLECTION
      // ====================================
      
      match /users/{userId} {
        // Users can read their own document
        allow read: if isTenantUser(tenantId) && isSameUser(userId);
        
        // Admins/Managers can read all users in their tenant
        allow read: if isAdminOrManager(tenantId);
        
        // Only backend can create/update user documents
        allow write: if false;
      }
      
      // ====================================
      // PROJECTS COLLECTION
      // ====================================
      
      match /projects/{projectId} {
        // Field users can read projects they're assigned to
        allow read: if isTenantUser(tenantId) 
                       && isAssignedToProject(resource.data);
        
        // Admins/Managers can read all projects in their tenant
        allow read: if isAdminOrManager(tenantId);
        
        // Only admins/managers can create/update projects
        // Field App is read-only for projects
        allow create, update: if isAdminOrManager(tenantId);
        allow delete: if false; // Soft-delete only
        
        // ====================================
        // TASKS SUB-COLLECTION
        // ====================================
        
        match /tasks/{taskId} {
          // Field users can read tasks they're assigned to
          allow read: if isTenantUser(tenantId) 
                         && isAssignedToTask(resource.data);
          
          // Admins/Managers can read all tasks
          allow read: if isAdminOrManager(tenantId);
          
          // Field users can update status of their assigned tasks
          allow update: if isTenantUser(tenantId)
                           && isAssignedToTask(resource.data)
                           && request.resource.data.diff(resource.data).affectedKeys()
                              .hasOnly(['status', 'updatedAt', 'completedAt']);
          
          // Admins/Managers have full control
          allow create, update, delete: if isAdminOrManager(tenantId);
        }
        
        // ====================================
        // NOTES SUB-COLLECTION
        // ====================================
        
        match /notes/{noteId} {
          // Field users can read notes for projects they're assigned to
          allow read: if isTenantUser(tenantId);
          
          // Field users can create notes
          allow create: if isTenantUser(tenantId)
                           && request.resource.data.userId == request.auth.uid
                           && request.resource.data.tenantId == tenantId;
          
          // Users can update/delete their own notes
          allow update, delete: if isTenantUser(tenantId)
                                   && resource.data.userId == request.auth.uid;
          
          // Admins/Managers have full control
          allow read, write: if isAdminOrManager(tenantId);
        }
        
        // ====================================
        // PHOTOS SUB-COLLECTION
        // ====================================
        
        match /photos/{photoId} {
          // Field users can read photos for projects they're assigned to
          allow read: if isTenantUser(tenantId);
          
          // Field users can create photo metadata
          allow create: if isTenantUser(tenantId)
                           && request.resource.data.userId == request.auth.uid
                           && request.resource.data.tenantId == tenantId
                           && request.resource.data.projectId == projectId;
          
          // Users cannot update/delete photos (immutable)
          allow update, delete: if false;
          
          // Admins/Managers can read all photos
          allow read: if isAdminOrManager(tenantId);
        }
      }
      
      // ====================================
      // TIME ENTRIES COLLECTION
      // ====================================
      
      match /timeEntries/{entryId} {
        // Field users can read their own time entries
        allow read: if isTenantUser(tenantId)
                       && resource.data.userId == request.auth.uid;
        
        // Admins/Managers can read all time entries
        allow read: if isAdminOrManager(tenantId);
        
        // Field users can create their own time entries
        allow create: if isTenantUser(tenantId)
                         && request.resource.data.userId == request.auth.uid
                         && request.resource.data.tenantId == tenantId;
        
        // Field users can update their own unconfirmed time entries
        allow update: if isTenantUser(tenantId)
                         && resource.data.userId == request.auth.uid
                         && resource.data.confirmed == false;
        
        // Only admins can confirm time entries
        allow update: if isAdminOrManager(tenantId)
                         && request.resource.data.diff(resource.data).affectedKeys()
                            .hasOnly(['confirmed']);
        
        // No deletion of time entries
        allow delete: if false;
      }
      
      // ====================================
      // REPORTS COLLECTION
      // ====================================
      
      match /reports/{reportId} {
        // Field users can read their own reports
        allow read: if isTenantUser(tenantId)
                       && resource.data.userId == request.auth.uid;
        
        // Admins/Managers can read all reports
        allow read: if isAdminOrManager(tenantId);
        
        // Field users can create their own reports
        allow create: if isTenantUser(tenantId)
                         && request.resource.data.userId == request.auth.uid
                         && request.resource.data.tenantId == tenantId;
        
        // Reports are immutable once created
        allow update, delete: if false;
      }
      
      // ====================================
      // AI MESSAGES COLLECTION
      // ====================================
      
      match /aiMessages/{messageId} {
        // Field users can read their own AI messages
        allow read: if isTenantUser(tenantId)
                       && resource.data.userId == request.auth.uid;
        
        // Admins/Managers can read all AI messages (for audit)
        allow read: if isAdminOrManager(tenantId);
        
        // Field users can create AI messages
        allow create: if isTenantUser(tenantId)
                         && request.resource.data.userId == request.auth.uid
                         && request.resource.data.tenantId == tenantId;
        
        // AI messages are immutable
        allow update, delete: if false;
      }
    }
  }
}
